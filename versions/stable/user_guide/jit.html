
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>A JIT-compiled solver &#8212; MICM 3.10.0 (stable) documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=bbe95013" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=c59e31e2"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/jit';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://ncar.github.io/micm/_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '3.10.0 (stable)';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Vectorized matrix solver" href="vectorized_matrix_solver.html" />
    <link rel="prev" title="OpenMP" href="openmp.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">MICM 3.10.0 (stable) documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting_started.html">
    Getting Started
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    MICM API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing/index.html">
    Contributing
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../citing_and_bibliography/index.html">
    Citations and Bibliography
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/NCAR/micm" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../getting_started.html">
    Getting Started
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    MICM API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing/index.html">
    Contributing
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../citing_and_bibliography/index.html">
    Citations and Bibliography
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/NCAR/micm" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation_and_usage.html">Installation and usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="rate_constant_tutorial.html">Rate Constants (except user defined ones)</a></li>
<li class="toctree-l1"><a class="reference internal" href="user_defined_rate_constant_tutorial.html">User-Defined Rate Constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="multiple_grid_cells.html">Multiple Grid Cells</a></li>
<li class="toctree-l1"><a class="reference internal" href="solver_configurations.html">Solver configurations</a></li>
<li class="toctree-l1"><a class="reference internal" href="solver_results.html">Solver results</a></li>
<li class="toctree-l1"><a class="reference internal" href="openmp.html">OpenMP</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">A JIT-compiled solver</a></li>
<li class="toctree-l1"><a class="reference internal" href="vectorized_matrix_solver.html">Vectorized matrix solver</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User Guide</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">A...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="a-jit-compiled-solver">
<span id="jit"></span><h1>A JIT-compiled solver<a class="headerlink" href="#a-jit-compiled-solver" title="Link to this heading">#</a></h1>
<p>Solving a chemical mechanism is a computationally intensive task. There are many reasons for this such as
multiple iterations by a solver to achieve an integration, stiff systems requiring internal substepping to
acheive a numerically stable solution, and cache misses, among others.</p>
<p>This tutorial focuses on alleviating the cache misses. A popular method for handling cache misses is to pre-compute the indices.
This method, which may be referred to as ahead-of-time (AOT) compilation, is used in applications such as KPP <span id="id1">[<a class="reference internal" href="../citing_and_bibliography/bibliography.html#id3" title="Valeriu Damian, Adrian Sandu, Mirela Damian, Florian Potra, and Gregory R. Carmichael. The kinetic preprocessor KPP-a software environment for solving chemical kinetics. Computers &amp; Chemical Engineering, 26(11):1567–1579, November 2002. doi:10.1016/S0098-1354(02)00128-X.">DSD+02</a>]</span>.
Pre-computed methods require code preprocessors and preclude runtime configurable software, which is a goal of MICM.</p>
<p>MICM uses just-in-time (JIT) compiled functions built with <a class="reference external" href="https://llvm.org/docs/tutorial/BuildingAJIT1.html">LLVM JIT</a> libraries
to supply runtime-configurable chemistry to avoid cache misses in important chemistry functions.</p>
<p>Up until now, a <a class="reference internal" href="../api/index.html#_CPPv4I00EN4micm16RosenbrockSolverE" title="micm::RosenbrockSolver"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">micm::RosenbrockSolver</span></code></a> has been used. This is a special class in MICM which builds all
of the componenets needed to solve chemistry in memory, including the forcing function and the jacobian. MICM
also provides a <a class="reference internal" href="../api/index.html#_CPPv4I00EN4micm19JitRosenbrockSolverE" title="micm::JitRosenbrockSolver"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">micm::JitRosenbrockSolver</span></code></a> which builds and compiles several important chemistry functions at runtime.</p>
<section id="what-are-we-jit-compilng">
<h2>What are we JIT-compilng?<a class="headerlink" href="#what-are-we-jit-compilng" title="Link to this heading">#</a></h2>
<p>A list of compiled functions is below. How they are compiled and the ellided operations are beyond the scope of this tutorial, but you are free to inspect the source code yourself.</p>
<ul class="simple">
<li><p><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::RosenbrockSolver::AlphaMinusJacobian()</span></code> is JIT compiled and called with <a class="reference internal" href="../api/index.html#_CPPv4I0ENK4micm19JitRosenbrockSolver18AlphaMinusJacobianEvR18SparseMatrixPolicyRNSt6vectorINSt6size_tEEERKd" title="micm::JitRosenbrockSolver::AlphaMinusJacobian"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::JitRosenbrockSolver::AlphaMinusJacobian()</span></code></a></p></li>
<li><p><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::LuDecomposition::Decompose()</span></code> is JIT compiled and called with <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::JitLuDecomposition::Decompose()</span></code></p></li>
<li><p><a class="reference internal" href="../api/index.html#_CPPv4NK4micm12LinearSolver6FactorERK18SparseMatrixPolicyR13LMatrixPolicyR13UMatrixPolicy" title="micm::LinearSolver::Factor"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::LinearSolver::Factor()</span></code></a> and <a class="reference internal" href="../api/index.html#_CPPv4I0ENK4micm12LinearSolver5SolveEvR12MatrixPolicyRK13LMatrixPolicyRK13UMatrixPolicy" title="micm::LinearSolver::Solve"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::LinearSolver::Solve()</span></code></a> are JIT compiled and called with <a class="reference internal" href="../api/index.html#_CPPv4NK4micm15JitLinearSolver6FactorER18SparseMatrixPolicyR18SparseMatrixPolicyR18SparseMatrixPolicy" title="micm::JitLinearSolver::Factor"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::JitLinearSolver::Factor()</span></code></a> and <a class="reference internal" href="../api/index.html#_CPPv4I0ENK4micm15JitLinearSolver5SolveEvR12MatrixPolicyR18SparseMatrixPolicyR18SparseMatrixPolicy" title="micm::JitLinearSolver::Solve"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::JitLinearSolver::Solve()</span></code></a></p></li>
<li><p><a class="reference internal" href="../api/index.html#_CPPv4I0ENK4micm10ProcessSet15AddForcingTermsEvRK17DenseMatrixPolicyRK17DenseMatrixPolicyR17DenseMatrixPolicy" title="micm::ProcessSet::AddForcingTerms"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::ProcessSet::AddForcingTerms()</span></code></a> and <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::ProcessSet::AddJacobianTerms()</span></code> are JIT compiled and called with <a class="reference internal" href="../api/index.html#_CPPv4I0ENK4micm13JitProcessSet15AddForcingTermsEvRK12MatrixPolicyRK12MatrixPolicyR12MatrixPolicy" title="micm::JitProcessSet::AddForcingTerms"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::JitProcessSet::AddForcingTerms()</span></code></a> and <code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">micm::JitProcessSet::AddJacobianTerms()</span></code></p></li>
</ul>
</section>
<section id="so-what-does-this-gain-me">
<h2>So what does this gain me?<a class="headerlink" href="#so-what-does-this-gain-me" title="Link to this heading">#</a></h2>
<p>Runtime configuraiton of chemical mechanisms that are <em>fast</em>. Let’s compare the speed of <a class="reference internal" href="../api/index.html#_CPPv4I00EN4micm16RosenbrockSolverE" title="micm::RosenbrockSolver"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">micm::RosenbrockSolver</span></code></a>
and the <a class="reference internal" href="../api/index.html#_CPPv4I00EN4micm19JitRosenbrockSolverE" title="micm::JitRosenbrockSolver"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">micm::JitRosenbrockSolver</span></code></a> classes applied to the same problem. We will use the simple
fictitous chemical system from previous examples for simplicity, but feel free to try out more complex
mechanisms to see the effects of JIT compiling on compute time in more realistic cases.</p>
<p>If you’re looking for a copy and paste, choose
the appropriate tab below and be on your way! Otherwise, stick around for a line by line explanation.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-0">
JIT-compiled Rosenbrock Solver</label><div class="sd-tab-content docutils">
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;micm/JIT.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;micm/Process.hpp&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="c1">// Use our namespace so that this example is easier to read</span>
<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">micm</span><span class="p">;</span>

<span class="k">constexpr</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="c1">// partial template specializations</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">using</span><span class="w"> </span><span class="n">GroupVectorMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">VectorMatrix</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">GroupSparseVectorMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">SparseMatrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">SparseMatrixVectorOrdering</span><span class="o">&lt;</span><span class="n">n_grid_cells</span><span class="o">&gt;&gt;</span><span class="p">;</span>

<span class="k">auto</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">solver</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">SolverStats</span><span class="w"> </span><span class="n">total_stats</span><span class="p">;</span>
<span class="w">  </span><span class="n">State</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">solver</span><span class="p">.</span><span class="n">GetState</span><span class="p">(</span><span class="n">n_grid_cells</span><span class="p">);</span>

<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">variables_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">conditions_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">temperature_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">287.45</span><span class="p">;</span><span class="w">  </span><span class="c1">// K</span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">conditions_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pressure_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">101319.9</span><span class="p">;</span><span class="w">   </span><span class="c1">// Pa</span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">conditions_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">air_density_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e6</span><span class="p">;</span><span class="w">     </span><span class="c1">// mol m-3</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">(</span><span class="s">&quot;Foo&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">foo_conc</span><span class="p">(</span><span class="n">n_grid_cells</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">SetConcentration</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">foo_conc</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// choose a timestep and print the initial state</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">time_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">;</span><span class="w">  </span><span class="c1">// s</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">total_solve_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">::</span><span class="n">zero</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// solve for ten iterations</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">elapsed_solve_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_solve_time</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">time_step</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="n">solver</span><span class="p">.</span><span class="n">CalculateRateConstants</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">solver</span><span class="p">.</span><span class="n">Solve</span><span class="p">(</span><span class="n">time_step</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">elapsed_solve_time</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="n">total_solve_time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="w">      </span><span class="n">elapsed_solve_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">final_time_</span><span class="p">;</span>

<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">function_calls_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">function_calls_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">jacobian_updates_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">jacobian_updates_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">number_of_steps_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">number_of_steps_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">accepted_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">rejected_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">rejected_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">decompositions_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">decompositions_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">solves_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">solves_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">total_stats</span><span class="p">,</span><span class="w"> </span><span class="n">total_solve_time</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Foo&quot;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Bar&quot;</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">baz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Baz&quot;</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="n">Phase</span><span class="w"> </span><span class="n">gas_phase</span><span class="p">{</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Species</span><span class="o">&gt;</span><span class="p">{</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="n">baz</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="n">System</span><span class="w"> </span><span class="n">chemical_system</span><span class="p">{</span><span class="w"> </span><span class="n">SystemParameters</span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">gas_phase_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gas_phase</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="n">Process</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChemicalReactionBuilder</span><span class="p">()</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetReactants</span><span class="p">({</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">})</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetProducts</span><span class="p">({</span><span class="w"> </span><span class="n">Yield</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span><span class="p">),</span><span class="w"> </span><span class="n">Yield</span><span class="p">(</span><span class="n">baz</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetRateConstant</span><span class="p">(</span><span class="n">ArrheniusRateConstant</span><span class="p">({</span><span class="w"> </span><span class="p">.</span><span class="n">A_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e-3</span><span class="w"> </span><span class="p">}))</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetPhase</span><span class="p">(</span><span class="n">gas_phase</span><span class="p">)</span>
<span class="w">                   </span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>

<span class="w">  </span><span class="n">Process</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChemicalReactionBuilder</span><span class="p">()</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetReactants</span><span class="p">({</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="p">})</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetProducts</span><span class="p">({</span><span class="w"> </span><span class="n">Yield</span><span class="p">(</span><span class="n">baz</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetRateConstant</span><span class="p">(</span><span class="n">ArrheniusRateConstant</span><span class="p">({</span><span class="w"> </span><span class="p">.</span><span class="n">A_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e-5</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">C_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">110.0</span><span class="w"> </span><span class="p">}))</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetPhase</span><span class="p">(</span><span class="n">gas_phase</span><span class="p">)</span>
<span class="w">                   </span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Process</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reactions</span><span class="p">{</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">solver_parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RosenbrockSolverParameters</span><span class="o">::</span><span class="n">ThreeStageRosenbrockParameters</span><span class="p">();</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">CpuSolverBuilder</span><span class="o">&lt;</span><span class="n">micm</span><span class="o">::</span><span class="n">RosenbrockSolverParameters</span><span class="o">&gt;</span><span class="p">(</span><span class="n">solver_parameters</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">SetSystem</span><span class="p">(</span><span class="n">chemical_system</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">SetReactions</span><span class="p">(</span><span class="n">reactions</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">JitSolverBuilder</span><span class="o">&lt;</span><span class="n">micm</span><span class="o">::</span><span class="n">JitRosenbrockSolverParameters</span><span class="p">,</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="o">&gt;</span><span class="p">(</span><span class="n">solver_parameters</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">SetSystem</span><span class="p">(</span><span class="n">chemical_system</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">SetReactions</span><span class="p">(</span><span class="n">reactions</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_compile_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Jit compile time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_compile_time</span><span class="p">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; nanoseconds&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">result_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_result_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="n">jit_solver</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Rerun for more fair comparison after assumed improvements to</span>
<span class="w">  </span><span class="c1">// branch-prediction during state update</span>
<span class="w">  </span><span class="n">result_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">);</span>
<span class="w">  </span><span class="n">jit_result_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="n">jit_solver</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Standard solve time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result_tuple</span><span class="p">).</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; nanoseconds&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;JIT solve time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">jit_result_tuple</span><span class="p">).</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; nanoseconds&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">result_stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result_tuple</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Standard solve stats: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">accepted: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">function_calls: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">function_calls_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">jacobian_updates: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">jacobian_updates_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">number_of_steps: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">number_of_steps_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">accepted: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">rejected: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">rejected_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">decompositions: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">decompositions_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">solves: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">solves_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">jit_result_tuple</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;JIT solve stats: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">accepted: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">function_calls: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">function_calls_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">jacobian_updates: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">jacobian_updates_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">number_of_steps: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">number_of_steps_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">accepted: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">rejected: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">rejected_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">decompositions: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">decompositions_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">solves: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">solves_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result_tuple</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">jit_result_tuple</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">species</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">variable_names_</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">variables_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">result</span><span class="p">.</span><span class="n">variable_map_</span><span class="p">[</span><span class="n">species</span><span class="p">]];</span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jit_result</span><span class="p">.</span><span class="n">variables_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jit_result</span><span class="p">.</span><span class="n">variable_map_</span><span class="p">[</span><span class="n">species</span><span class="p">]];</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0e-5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0e-30</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">species</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; does not match final concentration&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>To build and run the example using GNU (assuming the default install location), copy and
paste the example code into a file named <code class="docutils literal notranslate"><span class="pre">foo_jit_chem.cpp</span></code> and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>g++<span class="w"> </span>-o<span class="w"> </span>foo_jit_chem<span class="w"> </span>foo_jit_chem.cpp<span class="w"> </span>-I/usr/local/micm-3.2.0/include<span class="w"> </span><span class="sb">`</span>llvm-config<span class="w"> </span>--cxxflags<span class="w"> </span>--ldflags<span class="w"> </span>--system-libs<span class="w"> </span>--libs<span class="w"> </span>support<span class="w"> </span>core<span class="w"> </span>orcjit<span class="w"> </span>native<span class="w"> </span>irreader<span class="sb">`</span><span class="w"> </span>-std<span class="o">=</span>c++20<span class="w"> </span>-fexceptions
./foo_jit_chem
</pre></div>
</div>
</section>
<section id="line-by-line-explanation">
<h2>Line-by-line explanation<a class="headerlink" href="#line-by-line-explanation" title="Link to this heading">#</a></h2>
<p>Starting with the header files, we need headers for timing, output, and of course for both types of solvers.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;micm/JIT.hpp&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;micm/Process.hpp&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
</pre></div>
</div>
<p>Next, we use our namespace, define our number of gridcells (1 for now), and some
partial template specializations. We are using our custom vectorized matrix, which
groups mutliple reactions across grid cells into tiny blocks in a vector, allowing multiple
grid cells to be solved simultaneously.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// partial template specializations</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">using</span><span class="w"> </span><span class="n">GroupVectorMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">VectorMatrix</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span><span class="w"> </span><span class="n">GroupSparseVectorMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">SparseMatrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">SparseMatrixVectorOrdering</span><span class="o">&lt;</span><span class="n">n_grid_cells</span><span class="o">&gt;&gt;</span><span class="p">;</span>

<span class="k">auto</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">solver</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">SolverStats</span><span class="w"> </span><span class="n">total_stats</span><span class="p">;</span>
</pre></div>
</div>
<p>Now, all at once, is the function which runs either type of solver. We set all species
concentrations to 1 <span class="math notranslate nohighlight">\(\mathrm{mol\ m^-3}\)</span>.
Additionally, we are collecting all of the solver stats across all solving timesteps</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">variables_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">conditions_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">temperature_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">287.45</span><span class="p">;</span><span class="w">  </span><span class="c1">// K</span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">conditions_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pressure_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">101319.9</span><span class="p">;</span><span class="w">   </span><span class="c1">// Pa</span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="n">conditions_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">air_density_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e6</span><span class="p">;</span><span class="w">     </span><span class="c1">// mol m-3</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">(</span><span class="s">&quot;Foo&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">foo_conc</span><span class="p">(</span><span class="n">n_grid_cells</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
<span class="w">  </span><span class="n">state</span><span class="p">.</span><span class="n">SetConcentration</span><span class="p">(</span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">foo_conc</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// choose a timestep and print the initial state</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">time_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span><span class="p">;</span><span class="w">  </span><span class="c1">// s</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">total_solve_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">::</span><span class="n">zero</span><span class="p">();</span>

<span class="w">  </span><span class="c1">// solve for ten iterations</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">elapsed_solve_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed_solve_time</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">time_step</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="n">solver</span><span class="p">.</span><span class="n">CalculateRateConstants</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">solver</span><span class="p">.</span><span class="n">Solve</span><span class="p">(</span><span class="n">time_step</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">elapsed_solve_time</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">      </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">      </span><span class="n">total_solve_time</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>
<span class="w">      </span><span class="n">elapsed_solve_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">final_time_</span><span class="p">;</span>

<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">function_calls_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">function_calls_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">jacobian_updates_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">jacobian_updates_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">number_of_steps_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">number_of_steps_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">accepted_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">rejected_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">rejected_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">decompositions_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">decompositions_</span><span class="p">;</span>
<span class="w">      </span><span class="n">total_stats</span><span class="p">.</span><span class="n">solves_</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">stats_</span><span class="p">.</span><span class="n">solves_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">total_stats</span><span class="p">,</span><span class="w"> </span><span class="n">total_solve_time</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Species</span><span class="p">{</span><span class="w"> </span><span class="s">&quot;Foo&quot;</span><span class="w"> </span><span class="p">};</span>
</pre></div>
</div>
<p>Finally, the main function which defines the mechanism and initializes the jit solver.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">Phase</span><span class="w"> </span><span class="n">gas_phase</span><span class="p">{</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Species</span><span class="o">&gt;</span><span class="p">{</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="n">baz</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="n">System</span><span class="w"> </span><span class="n">chemical_system</span><span class="p">{</span><span class="w"> </span><span class="n">SystemParameters</span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">gas_phase_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gas_phase</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="n">Process</span><span class="w"> </span><span class="n">r1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChemicalReactionBuilder</span><span class="p">()</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetReactants</span><span class="p">({</span><span class="w"> </span><span class="n">foo</span><span class="w"> </span><span class="p">})</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetProducts</span><span class="p">({</span><span class="w"> </span><span class="n">Yield</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span><span class="w"> </span><span class="mf">0.8</span><span class="p">),</span><span class="w"> </span><span class="n">Yield</span><span class="p">(</span><span class="n">baz</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetRateConstant</span><span class="p">(</span><span class="n">ArrheniusRateConstant</span><span class="p">({</span><span class="w"> </span><span class="p">.</span><span class="n">A_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e-3</span><span class="w"> </span><span class="p">}))</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetPhase</span><span class="p">(</span><span class="n">gas_phase</span><span class="p">)</span>
<span class="w">                   </span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>

<span class="w">  </span><span class="n">Process</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChemicalReactionBuilder</span><span class="p">()</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetReactants</span><span class="p">({</span><span class="w"> </span><span class="n">foo</span><span class="p">,</span><span class="w"> </span><span class="n">bar</span><span class="w"> </span><span class="p">})</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetProducts</span><span class="p">({</span><span class="w"> </span><span class="n">Yield</span><span class="p">(</span><span class="n">baz</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetRateConstant</span><span class="p">(</span><span class="n">ArrheniusRateConstant</span><span class="p">({</span><span class="w"> </span><span class="p">.</span><span class="n">A_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e-5</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">C_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">110.0</span><span class="w"> </span><span class="p">}))</span>
<span class="w">                   </span><span class="p">.</span><span class="n">SetPhase</span><span class="p">(</span><span class="n">gas_phase</span><span class="p">)</span>
<span class="w">                   </span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Process</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reactions</span><span class="p">{</span><span class="w"> </span><span class="n">r1</span><span class="p">,</span><span class="w"> </span><span class="n">r2</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">solver_parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RosenbrockSolverParameters</span><span class="o">::</span><span class="n">ThreeStageRosenbrockParameters</span><span class="p">();</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">CpuSolverBuilder</span><span class="o">&lt;</span><span class="n">micm</span><span class="o">::</span><span class="n">RosenbrockSolverParameters</span><span class="o">&gt;</span><span class="p">(</span><span class="n">solver_parameters</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">SetSystem</span><span class="p">(</span><span class="n">chemical_system</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">SetReactions</span><span class="p">(</span><span class="n">reactions</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">micm</span><span class="o">::</span><span class="n">JitSolverBuilder</span><span class="o">&lt;</span><span class="n">micm</span><span class="o">::</span><span class="n">JitRosenbrockSolverParameters</span><span class="p">,</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="o">&gt;</span><span class="p">(</span><span class="n">solver_parameters</span><span class="p">)</span>
</pre></div>
</div>
<p>The only additional step here is to make an instance of the <a class="reference internal" href="../api/index.html#_CPPv4N4micm11JitCompilerE" title="micm::JitCompiler"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">micm::JitCompiler</span></code></a>
and pass it as a shared pointer to the <a class="reference internal" href="../api/index.html#_CPPv4I00EN4micm19JitRosenbrockSolverE" title="micm::JitRosenbrockSolver"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">micm::JitRosenbrockSolver</span></code></a>. We also are
using our vectorized matrix for both solvers. The <a class="reference internal" href="../api/index.html#_CPPv4I00EN4micm19JitRosenbrockSolverE" title="micm::JitRosenbrockSolver"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">micm::JitRosenbrockSolver</span></code></a> only works
with the vectorized matrix whereas the <a class="reference internal" href="../api/index.html#_CPPv4I00EN4micm16RosenbrockSolverE" title="micm::RosenbrockSolver"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">micm::RosenbrockSolver</span></code></a> works with a regular matrix.
At construction of the <a class="reference internal" href="../api/index.html#_CPPv4I00EN4micm19JitRosenbrockSolverE" title="micm::JitRosenbrockSolver"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">micm::JitRosenbrockSolver</span></code></a>, all JIT functions are compiled. We record that
time here.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">                        </span><span class="p">.</span><span class="n">SetReactions</span><span class="p">(</span><span class="n">reactions</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">Build</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_compile_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Jit compile time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_compile_time</span><span class="p">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; nanoseconds&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">result_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_result_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="n">jit_solver</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, we run both solvers, output their cumulative stats, and compare their results.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// branch-prediction during state update</span>
<span class="w">  </span><span class="n">result_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="n">solver</span><span class="p">);</span>
<span class="w">  </span><span class="n">jit_result_tuple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">run_solver</span><span class="p">(</span><span class="n">jit_solver</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Standard solve time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result_tuple</span><span class="p">).</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; nanoseconds&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;JIT solve time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">jit_result_tuple</span><span class="p">).</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; nanoseconds&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">result_stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result_tuple</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Standard solve stats: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">accepted: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">function_calls: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">function_calls_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">jacobian_updates: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">jacobian_updates_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">number_of_steps: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">number_of_steps_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">accepted: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">rejected: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">rejected_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">decompositions: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">decompositions_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">solves: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">result_stats</span><span class="p">.</span><span class="n">solves_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">jit_result_tuple</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;JIT solve stats: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">accepted: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">function_calls: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">function_calls_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">jacobian_updates: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">jacobian_updates_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">number_of_steps: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">number_of_steps_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">accepted: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">accepted_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">rejected: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">rejected_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">decompositions: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">decompositions_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">solves: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">jit_result_stats</span><span class="p">.</span><span class="n">solves_</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">result_tuple</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">jit_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">jit_result_tuple</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">species</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">variable_names_</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_grid_cells</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">variables_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">result</span><span class="p">.</span><span class="n">variable_map_</span><span class="p">[</span><span class="n">species</span><span class="p">]];</span>
<span class="w">      </span><span class="kt">double</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jit_result</span><span class="p">.</span><span class="n">variables_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jit_result</span><span class="p">.</span><span class="n">variable_map_</span><span class="p">[</span><span class="n">species</span><span class="p">]];</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0e-5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">b</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0e-30</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">species</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; does not match final concentration&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The output will be similar to this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Jit<span class="w"> </span>compile<span class="w"> </span>time:<span class="w"> </span><span class="m">38305334</span><span class="w"> </span>nanoseconds
Standard<span class="w"> </span>solve<span class="w"> </span>time:<span class="w"> </span><span class="m">122582</span><span class="w"> </span>nanoseconds
JIT<span class="w"> </span>solve<span class="w"> </span>time:<span class="w"> </span><span class="m">96541</span><span class="w"> </span>nanoseconds
Standard<span class="w"> </span>solve<span class="w"> </span>stats:
<span class="w">        </span>accepted:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>function_calls:<span class="w"> </span><span class="m">260</span>
<span class="w">        </span>jacobian_updates:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>number_of_steps:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>accepted:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>rejected:<span class="w"> </span><span class="m">0</span>
<span class="w">        </span>decompositions:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>solves:<span class="w"> </span><span class="m">390</span>
<span class="w">        </span>singular:<span class="w"> </span><span class="m">0</span>

JIT<span class="w"> </span>solve<span class="w"> </span>stats:
<span class="w">        </span>accepted:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>function_calls:<span class="w"> </span><span class="m">260</span>
<span class="w">        </span>jacobian_updates:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>number_of_steps:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>accepted:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>rejected:<span class="w"> </span><span class="m">0</span>
<span class="w">        </span>decompositions:<span class="w"> </span><span class="m">130</span>
<span class="w">        </span>solves:<span class="w"> </span><span class="m">390</span>
<span class="w">        </span>singular:<span class="w"> </span><span class="m">0</span>
</pre></div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="openmp.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">OpenMP</p>
      </div>
    </a>
    <a class="right-next"
       href="vectorized_matrix_solver.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Vectorized matrix solver</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-are-we-jit-compilng">What are we JIT-compilng?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#so-what-does-this-gain-me">So what does this gain me?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#line-by-line-explanation">Line-by-line explanation</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/user_guide/jit.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2022-2025, NCAR/UCAR.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>